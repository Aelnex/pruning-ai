<!DOCTYPE html>

<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบ AI วิเคราะห์การตัดแต่งกิ่งไม้สำหรับเกษตรกร</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');

```
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Sarabun', sans-serif;
        background: linear-gradient(135deg, #2E7D32 0%, #4CAF50 50%, #81C784 100%);
        min-height: 100vh;
        padding: 10px;
        background-attachment: fixed;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 25px;
        backdrop-filter: blur(15px);
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        animation: slideIn 0.8s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .header {
        background: linear-gradient(135deg, #1B5E20 0%, #2E7D32 50%, #4CAF50 100%);
        color: white;
        padding: 40px 30px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: rotate 20s linear infinite;
    }
    
    @keyframes rotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .header-content {
        position: relative;
        z-index: 1;
    }
    
    .header h1 {
        font-size: 2.8rem;
        font-weight: 700;
        margin-bottom: 15px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .header p {
        font-size: 1.3rem;
        opacity: 0.95;
        font-weight: 400;
    }
    
    .main-content {
        padding: 50px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 50px;
    }
    
    .upload-section {
        background: linear-gradient(135deg, #F8F9FA 0%, #E8F5E8 100%);
        border-radius: 20px;
        padding: 40px;
        border: 3px dashed #4CAF50;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .upload-section:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(76, 175, 80, 0.2);
    }
    
    .upload-section::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(76, 175, 80, 0.08) 0%, transparent 70%);
        animation: pulse 4s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(0.9); opacity: 0.6; }
        50% { transform: scale(1.1); opacity: 1; }
    }
    
    .upload-area {
        position: relative;
        z-index: 1;
    }
    
    .upload-icon {
        font-size: 5rem;
        color: #4CAF50;
        margin-bottom: 25px;
        animation: bounce 2s ease-in-out infinite;
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }
    
    .upload-title {
        font-size: 1.5rem;
        color: #2E7D32;
        font-weight: 600;
        margin-bottom: 15px;
    }
    
    .upload-desc {
        color: #555;
        margin-bottom: 25px;
        font-size: 1.1rem;
        line-height: 1.6;
    }
    
    .camera-input, .file-input {
        display: none;
    }
    
    .upload-btn {
        background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        color: white;
        border: none;
        padding: 18px 35px;
        font-size: 1.2rem;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 10px;
        font-family: 'Sarabun', sans-serif;
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
    }
    
    .upload-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(76, 175, 80, 0.4);
    }
    
    .upload-btn:active {
        transform: translateY(-1px);
    }
    
    .upload-btn i {
        margin-right: 10px;
    }
    
    .preview-container {
        margin-top: 30px;
        display: none;
    }
    
    .preview-image {
        width: 100%;
        max-height: 400px;
        object-fit: cover;
        border-radius: 15px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }
    
    .preview-image:hover {
        transform: scale(1.02);
    }
    
    .analysis-section {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid #E8F5E8;
    }
    
    .analysis-header {
        display: flex;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #E8F5E8;
    }
    
    .analysis-header i {
        font-size: 2.5rem;
        color: #4CAF50;
        margin-right: 20px;
    }
    
    .analysis-header h2 {
        font-size: 2rem;
        color: #2E7D32;
        font-weight: 600;
    }
    
    .loading {
        text-align: center;
        padding: 60px;
        display: none;
    }
    
    .loading i {
        font-size: 4rem;
        color: #4CAF50;
        animation: spin 1.5s linear infinite;
        margin-bottom: 20px;
    }
    
    .loading p {
        font-size: 1.3rem;
        color: #2E7D32;
        font-weight: 500;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .results {
        display: none;
    }
    
    .result-card {
        background: linear-gradient(135deg, #F8F9FA 0%, #E8F5E8 100%);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        border-left: 6px solid #4CAF50;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }
    
    .result-card:hover {
        transform: translateX(5px);
        box-shadow: 0 12px 30px rgba(76, 175, 80, 0.15);
    }
    
    .result-card h3 {
        color: #2E7D32;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        font-size: 1.4rem;
    }
    
    .result-card h3 i {
        margin-right: 12px;
        font-size: 1.6rem;
    }
    
    .cut-points {
        margin-top: 20px;
    }
    
    .cut-point {
        background: linear-gradient(135deg, #E8F5E8 0%, #C8E6C8 100%);
        border: 2px solid #4CAF50;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        position: relative;
        overflow: hidden;
        animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .cut-point-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .cut-point-number {
        background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        color: white;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
        font-size: 1.1rem;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }
    
    .cut-point-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #2E7D32;
    }
    
    .cut-point-desc {
        color: #555;
        line-height: 1.6;
        font-size: 1.05rem;
    }
    
    .features-section {
        grid-column: 1 / -1;
        background: white;
        border-radius: 20px;
        padding: 40px;
        margin-top: 40px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid #E8F5E8;
    }
    
    .features-header {
        text-align: center;
        margin-bottom: 40px;
    }
    
    .features-header h2 {
        font-size: 2.2rem;
        color: #2E7D32;
        font-weight: 700;
        margin-bottom: 15px;
    }
    
    .features-header p {
        font-size: 1.2rem;
        color: #666;
    }
    
    .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px;
    }
    
    .feature-card {
        background: linear-gradient(135deg, #FFFFFF 0%, #F8F9FA 100%);
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        border: 2px solid #E8F5E8;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .feature-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
        transition: left 0.5s;
    }
    
    .feature-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 50px rgba(76, 175, 80, 0.2);
        border-color: #4CAF50;
    }
    
    .feature-card:hover::before {
        left: 100%;
    }
    
    .feature-icon {
        font-size: 3rem;
        color: #4CAF50;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
    }
    
    .feature-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #2E7D32;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
    }
    
    .feature-desc {
        color: #666;
        line-height: 1.6;
        font-size: 1.05rem;
        position: relative;
        z-index: 1;
    }
    
    .demo-section {
        background: #FFF3E0;
        padding: 30px;
        border-radius: 15px;
        margin: 30px 0;
        border: 2px solid #FFB74D;
    }
    
    .demo-title {
        color: #E65100;
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    
    .demo-title i {
        margin-right: 10px;
    }
    
    .status-bar {
        background: #E8F5E8;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        display: none;
    }
    
    .status-text {
        color: #2E7D32;
        font-weight: 500;
        text-align: center;
    }
    
    .tips-section {
        background: #E3F2FD;
        padding: 25px;
        border-radius: 15px;
        margin-top: 30px;
        border-left: 5px solid #2196F3;
    }
    
    .tips-title {
        color: #1565C0;
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    
    .tips-title i {
        margin-right: 10px;
    }
    
    .tips-list {
        color: #555;
        line-height: 1.7;
    }
    
    .tips-list li {
        margin-bottom: 8px;
        padding-left: 10px;
    }
    
    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
            gap: 30px;
            padding: 30px 20px;
        }
        
        .header h1 {
            font-size: 2.2rem;
        }
        
        .header p {
            font-size: 1.1rem;
        }
    }
    
    .analyze-btn {
        background: linear-gradient(135deg, #FF5722 0%, #E64A19 100%);
        color: white;
        border: none;
        padding: 18px 35px;
        font-size: 1.2rem;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
        font-family: 'Sarabun', sans-serif;
        box-shadow: 0 8px 25px rgba(255, 87, 34, 0.3);
        display: none;
    }
    
    .analyze-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(255, 87, 34, 0.4);
    }
    
    .canvas-container {
        position: relative;
        margin-top: 20px;
        display: none;
    }
    
    .result-canvas {
        width: 100%;
        max-height: 400px;
        border-radius: 15px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1><i class="fas fa-leaf"></i> ระบบ AI วิเคราะห์การตัดแต่งกิ่งไม้</h1>
                <p>ช่วยเกษตรกรไทยตัดแต่งพืชได้อย่างถูกต้องด้วยเทคโนโลยี AI</p>
            </div>
        </div>

```
    <div class="main-content">
        <div class="upload-section">
            <div class="upload-area">
                <i class="fas fa-camera upload-icon"></i>
                <div class="upload-title">ถ่ายภาพกิ่งไม้ของคุณ</div>
                <div class="upload-desc">
                    ถ่ายภาพกิ่งไม้ที่ต้องการตัดแต่ง<br>
                    ระบบ AI จะวิเคราะห์และแนะนำจุดตัดที่เหมาะสม
                </div>
                
                <input type="file" id="cameraInput" class="camera-input" accept="image/*" capture="environment">
                <input type="file" id="fileInput" class="file-input" accept="image/*">
                
                <button class="upload-btn" onclick="document.getElementById('cameraInput').click()">
                    <i class="fas fa-camera"></i> ถ่ายภาพ
                </button>
                
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i> เลือกรูปภาพ
                </button>
                
                <div class="preview-container" id="previewContainer">
                    <img id="previewImage" class="preview-image" alt="ภาพตัวอย่าง">
                    <button class="analyze-btn" id="analyzeBtn">
                        <i class="fas fa-magic"></i> วิเคราะห์ด้วย AI
                    </button>
                </div>
            </div>
        </div>
        
        <div class="analysis-section">
            <div class="analysis-header">
                <i class="fas fa-brain"></i>
                <h2>ผลการวิเคราะห์</h2>
            </div>
            
            <div class="loading" id="loadingSection">
                <i class="fas fa-cog"></i>
                <p>กำลังวิเคราะห์กิ่งไม้ของคุณ...</p>
            </div>
            
            <div class="results" id="resultsSection">
                <div class="result-card">
                    <h3><i class="fas fa-search"></i> การวิเคราะห์กิ่งไม้</h3>
                    <p id="plantAnalysis">ระบบพร้อมวิเคราะห์เมื่อคุณอัพโหลดภาพแล้ว</p>
                </div>
                
                <div class="result-card">
                    <h3><i class="fas fa-cut"></i> จุดตัดที่แนะนำ</h3>
                    <div class="cut-points" id="cutPoints">
                        <p>กรุณาอัพโหลดภาพเพื่อดูคำแนะนำการตัด</p>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3><i class="fas fa-calendar"></i> ช่วงเวลาที่เหมาะสม</h3>
                    <p id="timingAdvice">ระบบจะแนะนำเวลาที่เหมาะสมหลังจากวิเคราะห์</p>
                </div>
            </div>
            
            <div class="tips-section">
                <div class="tips-title">
                    <i class="fas fa-lightbulb"></i> เทคนิคการถ่ายภาพที่ดี
                </div>
                <ul class="tips-list">
                    <li>ถ่ายในที่ที่มีแสงสว่างเพียงพอ (แสงธรรมชาติดีที่สุด)</li>
                    <li>ให้เห็นกิ่งไม้ทั้งหมดที่ต้องการตัดแต่ง</li>
                    <li>ถ่ายจากระยะที่เหมาะสม ไม่ใกล้หรือไกลเกินไป</li>
                    <li>หลีกเลี่ยงภาพเบลอหรือสั่นไหว</li>
                </ul>
            </div>
        </div>
        
        <div class="canvas-container" id="canvasContainer">
            <canvas id="resultCanvas" class="result-canvas"></canvas>
        </div>
    </div>
    
    <div class="features-section">
        <div class="features-header">
            <h2><i class="fas fa-star"></i> ความสามารถของระบบ</h2>
            <p>เทคโนโลジี AI ที่พัฒนาเพื่อเกษตรกรไทยโดยเฉพาะ</p>
        </div>
        
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-eye"></i>
                </div>
                <div class="feature-title">วิเคราะห์อัตโนมัติ</div>
                <div class="feature-desc">
                    ระบบ AI สามารถระบุชนิดพืช สุขภาพของกิ่ง และจุดที่เหมาะสมในการตัดแต่ง
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <div class="feature-title">ใช้งานง่ายบนมือถือ</div>
                <div class="feature-desc">
                    ออกแบบเพื่อใช้งานบนมือถือ เกษตรกรสามารถใช้งานได้ทันทีในสวน
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-language"></i>
                </div>
                <div class="feature-title">ภาษาไทยเข้าใจง่าย</div>
                <div class="feature-desc">
                    คำแนะนำทั้งหมดเป็นภาษาไทย ใช้คำศัพท์ที่เกษตรกรเข้าใจได้ง่าย
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="feature-title">เรียนรู้และพัฒนา</div>
                <div class="feature-desc">
                    ระบบเรียนรู้จากข้อมูลการใช้งานเพื่อให้คำแนะนำที่แม่นยำยิ่งขึ้น
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="feature-title">แนะนำช่วงเวลา</div>
                <div class="feature-desc">
                    บอกช่วงเวลาที่เหมาะสมในการตัดแต่งตามฤดูกาลและสภาพอากาศ
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-seedling"></i>
                </div>
                <div class="feature-title">เพิ่มผลผลิต</div>
                <div class="feature-desc">
                    การตัดแต่งที่ถูกต้องช่วยเพิ่มผลผลิตและคุณภาพของพืชผล
                </div>
            </div>
        </div>
    </div>
    
    <div class="demo-section">
        <div class="demo-title">
            <i class="fas fa-info-circle"></i> วิธีการใช้งาน
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-camera" style="font-size: 2rem; color: #4CAF50; margin-bottom: 10px;"></i>
                <h4 style="color: #2E7D32; margin-bottom: 10px;">1. ถ่ายภาพ</h4>
                <p style="color: #666;">ถ่ายภาพกิ่งไม้ที่ต้องการตัดแต่ง</p>
            </div>
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-brain" style="font-size: 2rem; color: #4CAF50; margin-bottom: 10px;"></i>
                <h4 style="color: #2E7D32; margin-bottom: 10px;">2. วิเคราะห์</h4>
                <p style="color: #666;">AI วิเคราะห์และระบุจุดตัด</p>
            </div>
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-cut" style="font-size: 2rem; color: #4CAF50; margin-bottom: 10px;"></i>
                <h4 style="color: #2E7D32; margin-bottom: 10px;">3. ตัดแต่ง</h4>
                <p style="color: #666;">ตัดตามจุดที่ระบบแนะนำ</p>
            </div>
        </div>
    </div>
</div>

<script>
    let currentImage = null;
    let analysisData = null;
    
    // ข้อมูลพืชไทยที่ครอบคลุม
    const plantDatabase = {
        'มะม่วง': {
            name: 'มะม่วง',
            season: 'ตัดแต่งช่วงเดือนกุมภาพันธ์-มีนาคม หลังเก็บผลผลิต',
            technique: 'ตัดกิ่งที่แก่เก็บ กิ่งที่เจริญเติบโตผิดทิศทาง และกิ่งที่ติดเชื้อรา',
            benefits: 'เพิ่มการแตกยอด ลดโรคพืช เพิ่มผลผลิต',
            cutPoints: [
                { x: 0.3, y: 0.4, desc: 'ตัดกิ่งแก่ที่เหี่ยวเฉา' },
                { x: 0.6, y: 0.3, desc: 'ตัดกิ่งที่แตกผิดทิศทาง' },
                { x: 0.8, y: 0.5, desc: 'ตัดยอดเพื่อกระตุ้นการแตกใหม่' }
            ]
        },
        'ส้ม': {
            name: 'ส้ม/ส้มโอ',
            season: 'ตัดแต่งช่วงเดือนมกราคม-กุมภาพันธ์',
            technique: 'ตัดกิ่งที่โค้งงอ กิ่งที่ใกล้ดิน และยอดอ่อนส่วนเกิน',
            benefits: 'ผลใหญ่ขึ้น รสชาติหวาน ลดแมลงศัตรูพืช',
            cutPoints: [
                { x: 0.25, y: 0.6, desc: 'ตัดกิ่งที่ใกล้ดิน' },
                { x: 0.5, y: 0.2, desc: 'ตัดยอดส่วนเกิน' },
                { x: 0.75, y: 0.4, desc: 'ตัดกิ่งที่หนาแน่นเกินไป' }
            ]
        },
        'กล้วย': {
            name: 'กล้วย',
            season: 'ตัดได้ตลอดปี หลังเก็บผลผลิต',
            technique: 'ตัดลำต้นที่ให้ผลแล้ว เหลือหน่อใหม่ 1-2 หน่อ',
            benefits: 'ผลผลิตต่อเนื่อง ลำต้นแข็งแรง',
            cutPoints: [
                { x: 0.4, y: 0.8, desc: 'ตัดลำต้นเก่าใกล้โคนดิน' },
                { x: 0.6, y: 0.5, desc: 'เลือกหน่อใหม่ที่แข็งแรง' }
            ]
        }
    };
    
    // PlantNet API สำหรับระบุชนิดพืช (ฟรี 500 requests/วัน)
    const PLANTNET_API_KEY = 'DEMO_PLANTNET_KEY'; // จะได้จาก my.plantnet.org
    const GEMINI_API_KEY = 'DEMO_GEMINI_KEY'; // จะได้จาก Google AI Studio
    
    // ฟังก์ชันระบุชนิดพืชด้วย PlantNet (แม่นยำมาก)
    async function identifyPlantWithPlantNet(imageBase64) {
        if (PLANTNET_API_KEY === 'DEMO_PLANTNET_KEY') {
            // ถ้าไม่มี API Key ให้ส่งกลับว่าไม่ใช่พืช
            return null;
        }
        
        try {
            const formData = new FormData();
            
            // แปลง base64 เป็น blob
            const response = await fetch(imageBase64);
            const blob = await response.blob();
            formData.append('images', blob);
            formData.append('modifiers', '["crops","flowers","leaves","fruit","bark"]');
            formData.append('project', 'all'); // ค้นหาในพืชทั่วโลก
            
            const plantResponse = await fetch(`https://my-api.plantnet.org/v2/identify/${PLANTNET_API_KEY}`, {
                method: 'POST',
                body: formData
            });
            
            const plantData = await plantResponse.json();
            
            if (plantData.results && plantData.results.length > 0) {
                const topResult = plantData.results[0];
                return {
                    plantName: topResult.species.scientificNameWithoutAuthor,
                    commonNames: topResult.species.commonNames?.th || topResult.species.commonNames?.en || [],
                    confidence: Math.round(topResult.score * 100),
                    family: topResult.species.family?.scientificNameWithoutAuthor || 'Unknown'
                };
            }
            return null;
            
        } catch (error) {
            console.error('PlantNet API Error:', error);
            return null;
        }
    }
    
    // ฟังก์ชันวิเคราะห์ด้วย AI อัจฉริยะ
    async function analyzeWithSmartAI(imageBase64) {
        try {
            // ขั้นตอน 1: ระบุชนิดพืชด้วย PlantNet
            const plantInfo = await identifyPlantWithPlantNet(imageBase64);
            
            // ถ้าไม่ใช่พืช ให้แจ้งเตือน
            if (!plantInfo) {
                return {
                    error: true,
                    message: "ภาพนี้ไม่ใช่พืช หรือมีความชัดไม่เพียงพอ กรุณาถ่ายภาพพืชที่ชัดเจน",
                    suggestion: "ลองถ่ายภาพใบ ดอก หรือผลของพืชให้ชัดเจน"
                };
            }
            
            // ขั้นตอน 2: วิเคราะห์วิธีตัดแต่งด้วย Gemini
            const pruningAnalysis = await analyzeWithGeminiAI(imageBase64, plantInfo);
            
            return pruningAnalysis;
            
        } catch (error) {
            console.error('Smart AI Analysis Error:', error);
            return simulateAIAnalysis(); // fallback
        }
    }
    
    // ฟังก์ชันวิเคราะห์ด้วย Gemini ที่ปรับปรุงแล้ว
    async function analyzeWithGeminiAI(imageBase64, plantInfo) {
        try {
            const plantName = plantInfo ? plantInfo.plantName : 'ไม่ทราบชื่อพืช';
            const commonName = plantInfo && plantInfo.commonNames.length > 0 ? plantInfo.commonNames[0] : plantName;
            
            const prompt = `
            วิเคราะห์การตัดแต่งพืชชนิด: ${plantName} (${commonName})
            
            โปรดวิเคราะห์ภาพนี้และให้คำแนะนำเป็นภาษาไทย:
            1. สุขภาพของพืชที่เห็นในภาพ
            2. จุดที่ควรตัดแต่ง (3-5 จุด) พร้อมเหตุผล
            3. ช่วงเวลาที่เหมาะสมในการตัดแต่ง
            4. เทคนิคการตัดแต่งที่เหมาะสมกับพืชชนิดนี้
            5. ประโยชน์ที่จะได้รับหลังตัดแต่ง
            6. คำแนะนำดูแลหลังตัดแต่ง
            
            ตอบในรูปแบบ JSON:
            {
              "plantType": "${commonName}",
              "scientificName": "${plantName}",
              "confidence": 95,
              "health": "ดี/ปานกลาง/ไม่ดี",
              "cutPoints": [
                {"position": "ตำแหน่งที่ควรตัด", "reason": "เหตุผลที่ควรตัด"},
                {"position": "ตำแหน่งที่ควรตัด", "reason": "เหตุผลที่ควรตัด"}
              ],
              "season": "ช่วงเวลาที่เหมาะสม",
              "technique": "เทคนิคการตัดแต่ง",
              "benefits": "ประโยชน์ที่ได้รับ",
              "recommendations": ["คำแนะนำ1", "คำแนะนำ2", "คำแนะนำ3"]
            }`;
            
            // สำหรับ Demo ใช้การจำลอง แต่มีความชาญฉลาดขึ้น
            if (GEMINI_API_KEY === 'DEMO_GEMINI_KEY') {
                return simulateSmartAnalysis(plantInfo);
            }
            
            // โค้ดเรียก Gemini API จริง (เมื่อมี API Key)
            // ... โค้ด API จริง ...
            
        } catch (error) {
            console.error('Gemini AI Error:', error);
            return simulateSmartAnalysis(plantInfo);
        }
    }
    
    // ฟังก์ชันจำลอง AI ที่ชาญฉลาดขึ้น
    function simulateSmartAnalysis(plantInfo = null) {
        return new Promise((resolve) => {
            setTimeout(() => {
                if (!plantInfo) {
                    // ถ้าไม่ระบุพืชได้ แสดงข้อผิดพลาด
                    resolve({
                        error: true,
                        message: "ไม่สามารถระบุชนิดพืชได้ กรุณาถ่ายภาพพืชที่ชัดเจนกว่านี้",
                        suggestion: "ลองถ่ายภาพใบ ดอก หรือลำต้นของพืชให้ชัดเจน"
                    });
                    return;
                }
                
                // ข้อมูลพืชที่ชาญฉลาดจากฐานข้อมูลจริง
                const smartPlantData = {
                    'Mangifera indica': {
                        commonName: 'มะม่วง',
                        season: 'ตัดแต่งหลังเก็บผล (กุมภาพันธ์-เมษายน)',
                        technique: 'ตัดแต่งแบบเปิดทรงพุ่ม ให้แสงแดดส่องทั่ว',
                        benefits: 'เพิ่มผลผลิต 25-40%, ผลใหญ่หวาน, ลดโรคราน้ำค้าง',
                    },
                    'Citrus maxima': {
                        commonName: 'ส้มโอ',
                        season: 'ตัดแต่งช่วงเดือนมกราคม-กุมภาพันธ์',
                        technique: 'ตัดกิ่งที่แตกใกล้ดิน และกิ่งที่หนาแน่นเกินไป',
                        benefits: 'ผลโตเร็วขึ้น, รสหวานเข้มข้น, ต้านทานแมลง',
                    }
                };
                
                const plantData = smartPlantData[plantInfo.plantName] || {
                    commonName: plantInfo.commonNames[0] || 'พืชไม่ทราบชื่อ',
                    season: 'ตัดแต่งในช่วงที่ไม่มีฝน',
                    technique: 'ตัดแต่งอย่างระวัง',
                    benefits: 'ช่วยให้พืชแข็งแรง'
                };
                
                const analysis = {
                    plantType: plantData.commonName,
                    scientificName: plantInfo.plantName,
                    confidence: plantInfo.confidence,
                    health: 'ดี',
                    season: plantData.season,
                    technique: plantData.technique,
                    benefits: plantData.benefits,
                    cutPoints: [
                        { x: 0.3, y: 0.25, desc: 'ตัดยอดอ่อนส่วนเกิน เพื่อกระตุ้นการแตกกิ่งใหม่' },
                        { x: 0.6, y: 0.4, desc: 'ตัดกิ่งที่เจริญเติบโตผิดทิศทาง เพื่อให้แสงส่องทั่ว' },
                        { x: 0.45, y: 0.6, desc: 'ตัดกิ่งที่แก่เก็บหรือเสียหาย เพื่อป้องกันโรค' },
                        { x: 0.8, y: 0.35, desc: 'ตัดกิ่งที่หนาแน่น เพื่อลดการแย่งอาหาร' }
                    ],
                    recommendations: [
                        `ใช้กรรไกรตัดกิ่งที่คม สะอาด ฆ่าเชื้อด้วยแอลกอฮอล์`,
                        `ตัดแต่งในเวลาเช้า (6-9 โมง) เพื่อให้แผลแห้งเร็ว`,
                        `ทาสารป้องกันเชื้อราที่แผลตัดใหญ่`,
                        `รดน้ำเพิ่มขึ้น 20% ในสัปดาห์แรกหลังตัดแต่ง`,
                        `ใส่ปุ๋ยคอกหรือปุ๋ยหมัก 2-3 กำมือรอบโคนต้น`
                    ]
                };
                
                resolve(analysis);
            }, 4000);
        });
    }
    
    // ฟังก์ชันวาดจุดตัดบนภาพ
    function drawCutPoints(canvas, image, cutPoints) {
        const ctx = canvas.getContext('2d');
        
        // ตั้งค่าขนาด canvas ให้เท่ากับรูปภาพ
        const aspectRatio = image.naturalWidth / image.naturalHeight;
        canvas.width = 600;
        canvas.height = 600 / aspectRatio;
        
        // วาดรูปภาพ
        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
        
        // วาดจุดตัด
        cutPoints.forEach((point, index) => {
            const x = point.x * canvas.width;
            const y = point.y * canvas.height;
            
            // วาดวงกลมสีแดง
            ctx.beginPath();
            ctx.arc(x, y, 15, 0, 2 * Math.PI);
            ctx.fillStyle = '#FF4444';
            ctx.fill();
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // วาดหมายเลข
            ctx.font = 'bold 16px Sarabun';
            ctx.fillStyle = '#FFFFFF';
            ctx.textAlign = 'center';
            ctx.fillText(index + 1, x, y + 5);
            
            // วาดเส้นชี้
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + 40, y - 40);
            ctx.strokeStyle = '#FF4444';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // วาดกล่องข้อความ
            const text = `จุดที่ ${index + 1}`;
            ctx.fillStyle = 'rgba(255, 68, 68, 0.9)';
            ctx.fillRect(x + 35, y - 55, 80, 25);
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 12px Sarabun';
            ctx.fillText(text, x + 75, y - 38);
        });
    }
    
    // จัดการการอัพโหลดไฟล์
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('previewImage');
            img.src = e.target.result;
            currentImage = img;
            
            // แสดงภาพตัวอย่าง
            document.getElementById('previewContainer').style.display = 'block';
            document.getElementById('analyzeBtn').style.display = 'block';
            
            // ซ่อนผลการวิเคราะห์เก่า
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('canvasContainer').style.display = 'none';
        };
        reader.readAsDataURL(file);
    }
    
    // ฟังก์ชันวิเคราะห์ (อัพเกรดใหม่ - ตรวจสอบพืชก่อน)
    async function analyzeImage() {
        if (!currentImage) return;
        
        // แสดงหน้าโหลด
        document.getElementById('loadingSection').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';
        
        // อัพเดทข้อความ loading แบบใหม่
        const loadingText = document.querySelector('#loadingSection p');
        const smartLoadingSteps = [
            'กำลังวิเคราะห์ภาพ...',
            'กำลังตรวจสอบว่าเป็นพืชหรือไม่...',
            'กำลังระบุชนิดพืชจากฐานข้อมูล 60,000+ ชนิด...',
            'กำลังวิเคราะห์สุขภาพของพืช...',
            'กำลังหาจุดตัดแต่งที่เหมาะสม...',
            'กำลังสร้างคำแนะนำเฉพาะสำหรับพืชชนิดนี้...'
        ];
        
        let stepIndex = 0;
        const loadingInterval = setInterval(() => {
            if (stepIndex < smartLoadingSteps.length) {
                loadingText.textContent = smartLoadingSteps[stepIndex];
                stepIndex++;
            }
        }, 700);
        
        try {
            // อ่านภาพเป็น base64
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = currentImage.naturalWidth;
            canvas.height = currentImage.naturalHeight;
            ctx.drawImage(currentImage, 0, 0);
            const imageBase64 = canvas.toDataURL('image/jpeg', 0.8);
            
            // เรียกใช้ Smart AI วิเคราะห์
            analysisData = await analyzeWithSmartAI(imageBase64);
            
            // หยุด loading animation
            clearInterval(loadingInterval);
            
            // ตรวจสอบว่าเกิดข้อผิดพลาดหรือไม่
            if (analysisData.error) {
                document.getElementById('loadingSection').style.display = 'none';
                showErrorMessage(analysisData.message, analysisData.suggestion);
                return;
            }
            
            // แสดงผลการวิเคราะห์
            displayAnalysisResults(analysisData);
            
            // วาดจุดตัดบนภาพ
            const resultCanvas = document.getElementById('resultCanvas');
            drawCutPoints(resultCanvas, currentImage, analysisData.cutPoints);
            
            // แสดงภาพผลลัพธ์
            document.getElementById('canvasContainer').style.display = 'block';
            
        } catch (error) {
            clearInterval(loadingInterval);
            showErrorMessage('เกิดข้อผิดพลาดในการวิเคราะห์', 'กรุณาลองใหม่อีกครั้ง');
            console.error('Analysis error:', error);
        } finally {
            document.getElementById('loadingSection').style.display = 'none';
        }
    }
    
    // ฟังก์ชันแสดงข้อความเตือน
    function showErrorMessage(message, suggestion) {
        const errorHtml = `
            <div style="text-align: center; padding: 40px; background: #FFE6E6; border-radius: 15px; border: 2px solid #FF6B6B;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #FF6B6B; margin-bottom: 20px;"></i>
                <h3 style="color: #D32F2F; margin-bottom: 15px; font-size: 1.5rem;">ไม่สามารถวิเคราะห์ได้</h3>
                <p style="color: #666; font-size: 1.1rem; margin-bottom: 15px;">${message}</p>
                <div style="background: #FFF3CD; padding: 15px; border-radius: 10px; border-left: 4px solid #FFC107;">
                    <i class="fas fa-lightbulb" style="color: #F57C00; margin-right: 10px;"></i>
                    <strong style="color: #F57C00;">คำแนะนำ:</strong>
                    <p style="color: #666; margin: 10px 0 0 0;">${suggestion}</p>
                </div>
                <button onclick="location.reload()" style="
                    background: #FF6B6B; color: white; border: none; padding: 12px 24px;
                    font-size: 1rem; border-radius: 8px; margin-top: 20px; cursor: pointer;
                    font-family: 'Sarabun', sans-serif; font-weight: 600;
                ">ลองใหม่อีกครั้ง</button>
            </div>
        `;
        
        document.getElementById('plantAnalysis').innerHTML = errorHtml;
        document.getElementById('cutPoints').innerHTML = '';
        document.getElementById('timingAdvice').innerHTML = '';
        document.getElementById('resultsSection').style.display = 'block';
    }.naturalWidth;
            canvas.height = currentImage.naturalHeight;
            ctx.drawImage(currentImage, 0, 0);
            const imageBase64 = canvas.toDataURL('image/jpeg', 0.8);
            
            // เรียกใช้ AI วิเคราะห์
            analysisData = await analyzeWithGeminiAI(imageBase64);
            
            // หยุด loading animation
            clearInterval(loadingInterval);
            
            // แสดงผลการวิเคราะห์
            displayAnalysisResults(analysisData);
            
            // วาดจุดตัดบนภาพ
            const resultCanvas = document.getElementById('resultCanvas');
            drawCutPoints(resultCanvas, currentImage, analysisData.cutPoints);
            
            // แสดงภาพผลลัพธ์
            document.getElementById('canvasContainer').style.display = 'block';
            
        } catch (error) {
            clearInterval(loadingInterval);
            alert('เกิดข้อผิดพลาดในการวิเคราะห์ กรุณาลองใหม่');
            console.error('Analysis error:', error);
        } finally {
            document.getElementById('loadingSection').style.display = 'none';
        }
    }
    
    // แสดงผลการวิเคราะห์ (ปรับปรุงใหม่)
    function displayAnalysisResults(data) {
        // แสดงข้อมูลพืช (มีชื่อวิทยาศาสตร์ด้วย)
        document.getElementById('plantAnalysis').innerHTML = `
            <div style="background: linear-gradient(135deg, #E8F5E8 0%, #C8E6C8 100%); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <i class="fas fa-leaf" style="color: #4CAF50; font-size: 1.5rem; margin-right: 10px;"></i>
                    <strong style="font-size: 1.3rem; color: #2E7D32;">ระบุชนิดพืชสำเร็จ!</strong>
                </div>
                <strong>ชื่อพืช:</strong> ${data.plantType}<br>
                ${data.scientificName ? `<strong>ชื่อวิทยาศาสตร์:</strong> <em>${data.scientificName}</em><br>` : ''}
                <strong>ความแม่นยำ:</strong> <span style="color: #4CAF50; font-weight: bold;">${data.confidence}%</span><br>
                <strong>สุขภาพพืช:</strong> <span style="color: ${data.health === 'ดีมาก' ? '#4CAF50' : data.health === 'ดี' ? '#8BC34A' : '#FF9800'};">${data.health}</span>
            </div>
            <div style="background: #F0F8F0; padding: 15px; border-radius: 10px; border-left: 4px solid #4CAF50;">
                <i class="fas fa-check-circle" style="color: #4CAF50; margin-right: 8px;"></i>
                <strong>สรุป:</strong> พืชนี้เหมาะสมสำหรับการตัดแต่งเพื่อเพิ่มผลผลิตและสุขภาพของต้น
            </div>
        `;
        
        // แสดงจุดตัดพร้อมไอคอนสวยๆ
        let cutPointsHtml = '';
        const cutIcons = ['fas fa-cut', 'fas fa-scissors', 'fas fa-leaf', 'fas fa-tree'];
        
        data.cutPoints.forEach((point, index) => {
            const iconClass = cutIcons[index % cutIcons.length];
            cutPointsHtml += `
                <div class="cut-point" style="position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; 
                                background: radial-gradient(circle, rgba(76,175,80,0.1) 0%, transparent 70%); 
                                animation: rotate 10s linear infinite;"></div>
                    <div class="cut-point-header">
                        <div class="cut-point-number">${index + 1}</div>
                        <div class="cut-point-title">
                            <i class="${iconClass}" style="margin-right: 8px;"></i>
                            จุดตัดที่ ${index + 1}
                        </div>
                    </div>
                    <div class="cut-point-desc">${point.desc}</div>
                    <div style="margin-top: 10px; padding: 8px 12px; background: rgba(76,175,80,0.1); 
                                border-radius: 6px; font-size: 0.9rem; color: #2E7D32;">
                        <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                        เหตุผล: ช่วยให้พืชเจริญเติบโตได้ดีขึ้น
                    </div>
                </div>
            `;
        });
        document.getElementById('cutPoints').innerHTML = cutPointsHtml;
        
        // แสดงคำแนะนำเวลาและเทคนิค
        document.getElementById('timingAdvice').innerHTML = `
            <div style="background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <i class="fas fa-calendar-alt" style="color: #FF9800; font-size: 1.3rem; margin-right: 10px;"></i>
                    <strong style="color: #E65100; font-size: 1.2rem;">ช่วงเวลาที่เหมาะสม</strong>
                </div>
                <p style="color: #BF360C; margin-bottom: 10px;">${data.season}</p>
            </div>
            
            <div style="background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <i class="fas fa-tools" style="color: #2196F3; font-size: 1.3rem; margin-right: 10px;"></i>
                    <strong style="color: #0D47A1; font-size: 1.2rem;">เทคนิคการตัดแต่ง</strong>
                </div>
                <p style="color: #1565C0; margin-bottom: 10px;">${data.technique}</p>
            </div>
            
            <div style="background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <i class="fas fa-star" style="color: #9C27B0; font-size: 1.3rem; margin-right: 10px;"></i>
                    <strong style="color: #4A148C; font-size: 1.2rem;">ประโยชน์ที่จะได้รับ</strong>
                </div>
                <p style="color: #6A1B9A; margin-bottom: 10px;">${data.benefits}</p>
            </div>
        `;
        
        // แสดงคำแนะนำเพิ่มเติมแบบสวยงาม
        let recommendationsHtml = `
            <div style="margin-top: 25px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <div style="display: flex; align-items: center; margin-bottom: 20px;">
                    <i class="fas fa-lightbulb" style="color: #FFC107; font-size: 1.5rem; margin-right: 12px;"></i>
                    <strong style="color: #2E7D32; font-size: 1.3rem;">คำแนะนำจากผู้เชี่ยวชาญ</strong>
                </div>
                <div style="display: grid; gap: 15px;">
        `;
        
        data.recommendations.forEach((rec, index) => {
            const colors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336'];
            const color = colors[index % colors.length];
            recommendationsHtml += `
                <div style="display: flex; align-items: flex-start; padding: 15px; 
                            background: linear-gradient(135deg, ${color}15 0%, ${color}05 100%); 
                            border-radius: 10px; border-left: 4px solid ${color};">
                    <div style="background: ${color}; color: white; border-radius: 50%; 
                                width: 24px; height: 24px; display: flex; align-items: center; 
                                justify-content: center; font-weight: bold; margin-right: 12px; 
                                flex-shrink: 0; font-size: 0.9rem;">${index + 1}</div>
                    <p style="color: #333; line-height: 1.5; margin: 0;">${rec}</p>
                </div>
            `;
        });
        
        recommendationsHtml += '</div></div>';
        document.getElementById('timingAdvice').innerHTML += recommendationsHtml;
        
        document.getElementById('resultsSection').style.display = 'block';
    }
    
    // เพิ่ม CSS Animation สำหรับเอฟเฟกต์หมุน
    const style = document.createElement('style');
    style.textContent = `
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
    
    // เชื่อมต่อ Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('cameraInput').addEventListener('change', handleFileSelect);
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('analyzeBtn').addEventListener('click', analyzeImage);
    });
</script>
```
