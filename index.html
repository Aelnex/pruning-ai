<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏∑‡∏ä - ‡∏£‡∏π‡πâ‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 800;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .camera-button, .gallery-button {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .camera-button {
            background: rgba(255,255,255,0.9);
            color: #2e7d32;
            height: 120px;
            font-size: 1.5em;
        }

        .gallery-button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .camera-button:hover, .gallery-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .file-input {
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            margin: 20px 0;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            display: none;
            background: white;
            color: #333;
            border-radius: 20px;
            padding: 25px;
            margin-top: 20px;
        }

        .result.show {
            display: block;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-image {
            width: 100%;
            max-height: 250px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .plant-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .plant-name {
            font-size: 1.4em;
            font-weight: 700;
            color: #2e7d32;
            margin-bottom: 5px;
        }

        .confidence {
            background: #4caf50;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
            display: inline-block;
        }

        .cutting-section {
            margin-top: 20px;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cutting-point {
            background: #fff3e0;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 10px;
            border-left: 4px solid #ff9800;
        }

        .point-title {
            font-weight: 600;
            color: #e65100;
            margin-bottom: 5px;
        }

        .point-desc {
            color: #5d4037;
            line-height: 1.5;
        }

        .tips {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid #2196f3;
        }

        .tips-title {
            font-weight: 700;
            color: #1565c0;
            margin-bottom: 8px;
        }

        .tips-content {
            color: #0d47a1;
            line-height: 1.6;
        }

        .new-scan {
            width: 100%;
            padding: 15px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .new-scan:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #f44336;
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .camera-button {
                height: 100px;
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåø ‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏∑‡∏ä</h1>
            <p>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ ‚Üí ‡∏£‡∏π‡πâ‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
            <div style="font-size: 0.9em; margin-top: 10px; opacity: 0.8;">
                ‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏î‡∏¢ PlantNet AI ‚Ä¢ ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏û‡∏∑‡∏ä 60,000+ ‡∏ä‡∏ô‡∏¥‡∏î
            </div>
        </div>

        <button class="camera-button" onclick="takePhoto()">
            üì± ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏û‡∏∑‡∏ä
        </button>

        <button class="gallery-button" onclick="selectFromGallery()">
            üñºÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á
        </button>

        <input type="file" id="photoInput" class="file-input" accept="image/*" capture="environment">
        <input type="file" id="galleryInput" class="file-input" accept="image/*">

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div>üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏∑‡∏ä...</div>
            <div id="loadingText" style="font-size: 0.9em; margin-top: 10px; opacity: 0.8;">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏†‡∏≤‡∏û...
            </div>
        </div>

        <div id="result" class="result">
            <img id="resultImage" class="result-image">
            
            <div class="plant-info">
                <div class="plant-name" id="plantName">üå± ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡∏ä</div>
                <span class="confidence" id="confidence">95%</span>
            </div>

            <div class="cutting-section">
                <div class="section-title">‚úÇÔ∏è ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ï‡∏±‡∏î</div>
                <div id="cuttingPoints"></div>
            </div>

            <div class="tips">
                <div class="tips-title">üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</div>
                <div class="tips-content" id="tipsText">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
            </div>

            <button class="new-scan" onclick="newScan()">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>

    <script>
        // API Key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PlantNet (‡∏ù‡∏±‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î)
        const PLANTNET_API_KEY = '2b10fVqZpXS2cvXW6EyaPHqJu';
        
        // Global error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            hideLoading();
            showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            hideLoading();
            showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
        });

        // Event listeners - Safe DOM ready check
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        function initializeApp() {
            try {
                // Safe element binding
                const photoInput = document.getElementById('photoInput');
                const galleryInput = document.getElementById('galleryInput');
                
                if (photoInput) {
                    photoInput.addEventListener('change', handlePhoto);
                }
                if (galleryInput) {
                    galleryInput.addEventListener('change', handlePhoto);
                }
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        function takePhoto() {
            try {
                const input = document.getElementById('photoInput');
                if (input) {
                    input.click();
                } else {
                    throw new Error('Photo input not found');
                }
            } catch (error) {
                console.error('Take photo error:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ');
            }
        }

        function selectFromGallery() {
            try {
                const input = document.getElementById('galleryInput');
                if (input) {
                    input.click();
                } else {
                    throw new Error('Gallery input not found');
                }
            } catch (error) {
                console.error('Select gallery error:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πÑ‡∏î‡πâ');
            }
        }

        function handlePhoto(event) {
            try {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    return;
                }

                // Show preview safely
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const img = document.getElementById('resultImage');
                        if (img) {
                            img.src = e.target.result;
                        }
                    } catch (error) {
                        console.error('Image preview error:', error);
                    }
                };
                reader.onerror = function() {
                    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ');
                };
                reader.readAsDataURL(file);

                // Start analysis
                analyzePhoto(file);
            } catch (error) {
                console.error('Handle photo error:', error);
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ');
            }
        }

        async function analyzePhoto(file) {
            try {
                showLoading();
                
                // Try PlantNet API first
                let result = null;
                try {
                    result = await analyzePlantNetAPI(file);
                } catch (apiError) {
                    console.warn('PlantNet API failed, using demo mode:', apiError);
                    result = await analyzeDemoMode();
                }
                
                hideLoading();
                showResult(result);
                
            } catch (error) {
                console.error('Analysis error:', error);
                hideLoading();
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            }
        }

        async function analyzePlantNetAPI(file) {
            const updateLoadingText = (text) => {
                const loadingTextEl = document.getElementById('loadingText');
                if (loadingTextEl) {
                    loadingTextEl.textContent = text;
                }
            };

            updateLoadingText('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ PlantNet AI...');
            
            const formData = new FormData();
            formData.append('images', file);
            formData.append('modifiers', '["crops","flowers","fruits","barks","leaves"]');
            formData.append('plant-identification', 'true');

            const projects = ['weurope', 'k-world-flora', 'the-plant-list'];
            
            for (const project of projects) {
                try {
                    updateLoadingText(`‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${project.toUpperCase()}...`);
                    
                    const response = await fetch(`https://my-api.plantnet.org/v1/identify/${project}?api-key=${PLANTNET_API_KEY}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.results && data.results.length > 0) {
                        const topResult = data.results[0];
                        const species = topResult.species;
                        
                        updateLoadingText('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡∏ä! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î...');
                        
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        return {
                            isReal: true,
                            name: species.commonNames && species.commonNames.length > 0 
                                ? species.commonNames[0] 
                                : species.scientificNameWithoutAuthor,
                            scientificName: species.scientificNameWithoutAuthor,
                            confidence: Math.round(topResult.score * 100),
                            genus: species.genus?.scientificNameWithoutAuthor || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö',
                            family: species.family?.scientificNameWithoutAuthor || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö',
                            source: `PlantNet ${project.toUpperCase()}`
                        };
                    }
                } catch (error) {
                    console.log(`Failed to search in ${project}:`, error);
                    continue;
                }
            }
            
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡∏ä‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PlantNet');
        }

        async function analyzeDemoMode() {
            const updateLoadingText = (text) => {
                const loadingTextEl = document.getElementById('loadingText');
                if (loadingTextEl) {
                    loadingTextEl.textContent = text;
                }
            };

            updateLoadingText('‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î Demo...');
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const demoPlants = [
                {
                    isReal: false,
                    name: '‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ',
                    scientificName: 'Mangifera indica',
                    confidence: 92,
                    genus: 'Mangifera',
                    family: 'Anacardiaceae',
                    source: 'Demo Mode'
                },
                {
                    isReal: false,
                    name: '‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÑ‡∏Ç‡πà',
                    scientificName: 'Musa acuminata',
                    confidence: 89,
                    genus: 'Musa',
                    family: 'Musaceae',
                    source: 'Demo Mode'
                },
                {
                    isReal: false,
                    name: '‡∏°‡∏∞‡∏•‡∏∞‡∏Å‡∏≠',
                    scientificName: 'Carica papaya',
                    confidence: 94,
                    genus: 'Carica',
                    family: 'Caricaceae',
                    source: 'Demo Mode'
                }
            ];
            
            return demoPlants[Math.floor(Math.random() * demoPlants.length)];
        }

        function showLoading() {
            try {
                const loading = document.getElementById('loading');
                const result = document.getElementById('result');
                
                if (loading) {
                    loading.classList.add('show');
                }
                if (result) {
                    result.classList.remove('show');
                }

                // Loading steps
                const steps = [
                    '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏†‡∏≤‡∏û...',
                    '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏û‡∏∑‡∏ä...',
                    '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î...',
                    '‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß...'
                ];

                let step = 0;
                const interval = setInterval(() => {
                    const loadingTextEl = document.getElementById('loadingText');
                    if (step < steps.length && loadingTextEl) {
                        loadingTextEl.textContent = steps[step];
                        step++;
                    } else {
                        clearInterval(interval);
                    }
                }, 750);
            } catch (error) {
                console.error('Show loading error:', error);
            }
        }

        function hideLoading() {
            try {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.classList.remove('show');
                }
            } catch (error) {
                console.error('Hide loading error:', error);
            }
        }

        function showResult(result) {
            try {
                if (!result) {
                    throw new Error('No result data');
                }

                // Safe element selection
                const plantNameEl = document.getElementById('plantName');
                const confidenceEl = document.getElementById('confidence');
                const cuttingPointsEl = document.getElementById('cuttingPoints');
                const tipsTextEl = document.getElementById('tipsText');
                const resultEl = document.getElementById('result');

                // Set plant info with more details
                const plantInfo = `üå± ${result.name}`;
                
                if (plantNameEl) {
                    plantNameEl.innerHTML = `
                        <div style="font-size: 1.4em; font-weight: 700; color: #2e7d32; margin-bottom: 5px;">
                            ${plantInfo}
                        </div>
                        <div style="font-style: italic; color: #666; font-size: 0.9em; margin-bottom: 5px;">
                            ${result.scientificName}
                        </div>
                        <div style="font-size: 0.8em; color: #666;">
                            ‡∏™‡∏Å‡∏∏‡∏•: ${result.genus} | ‡∏ß‡∏á‡∏®‡πå: ${result.family}
                        </div>
                    `;
                }

                if (confidenceEl) {
                    confidenceEl.textContent = `${result.confidence}%`;
                    confidenceEl.style.background = result.isReal ? '#4caf50' : '#ff9800';
                }

                // Add source badge
                if (confidenceEl && confidenceEl.parentNode) {
                    const sourceBadge = document.createElement('span');
                    sourceBadge.style.cssText = `
                        background: ${result.isReal ? '#2196f3' : '#ff9800'};
                        color: white;
                        padding: 4px 8px;
                        border-radius: 12px;
                        font-size: 0.8em;
                        margin-left: 8px;
                    `;
                    sourceBadge.textContent = result.source;
                    confidenceEl.parentNode.appendChild(sourceBadge);
                }

                // Generate cutting advice
                const cuttingAdvice = generateCuttingAdvice(result.name, result.scientificName);
                
                if (cuttingPointsEl && cuttingAdvice.points) {
                    const pointsHTML = cuttingAdvice.points.map((point, index) => `
                        <div class="cutting-point">
                            <div class="point-title">${index + 1}. ${point.title}</div>
                            <div class="point-desc">${point.desc}</div>
                        </div>
                    `).join('');
                    cuttingPointsEl.innerHTML = pointsHTML;
                }

                if (tipsTextEl && cuttingAdvice.tips) {
                    tipsTextEl.textContent = cuttingAdvice.tips;
                }

                if (resultEl) {
                    resultEl.classList.add('show');
                    setTimeout(() => {
                        resultEl.scrollIntoView({ behavior: 'smooth' });
                    }, 300);
                }

            } catch (error) {
                console.error('Show result error:', error);
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•');
            }
        }

        function generateCuttingAdvice(plantName, scientificName) {
            try {
                const plantFamilies = {
                    'Mangifera': 'fruit_tree',
                    'Citrus': 'fruit_tree', 
                    'Carica': 'tropical_fruit',
                    'Musa': 'banana_family',
                    'Ficus': 'ornamental_tree',
                    'Capsicum': 'vegetable',
                    'Solanum': 'vegetable'
                };

                let category = 'general';
                for (const [genus, type] of Object.entries(plantFamilies)) {
                    if (scientificName && scientificName.includes(genus)) {
                        category = type;
                        break;
                    }
                }

                const adviceMap = {
                    fruit_tree: {
                        points: [
                            { title: '‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏ô‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏•‡∏≥‡∏ï‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏Å', desc: '‡∏Å‡∏¥‡πà‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∞‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏•‡∏≥‡∏ï‡πâ‡∏ô ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏î‡∏∏‡∏•' },
                            { title: '‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏°‡∏∏‡∏°‡πÅ‡∏Ñ‡∏ö (‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 45 ‡∏≠‡∏á‡∏®‡∏≤)', desc: '‡∏Å‡∏¥‡πà‡∏á‡∏°‡∏∏‡∏°‡πÅ‡∏Ñ‡∏ö‡∏à‡∏∞‡∏´‡∏±‡∏Å‡∏á‡πà‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ú‡∏• ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏±‡∏î‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô' },
                            { title: '‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏î‡∏™‡∏µ‡∏Å‡∏±‡∏ô', desc: '‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏î‡∏™‡∏µ' }
                        ],
                        tips: '‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏Å‡∏ï‡∏±‡∏ß ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å‡∏ï‡∏¥‡∏î‡∏ú‡∏• ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ñ‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏ó‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏Å‡πä‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏•‡∏ï‡∏±‡∏î'
                    },
                    tropical_fruit: {
                        points: [
                            { title: '‡∏ï‡∏±‡∏î‡πÉ‡∏ö‡πÅ‡∏Å‡πà‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á', desc: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä' },
                            { title: '‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡πà‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏à‡∏≤‡∏Å‡∏•‡∏≥‡∏ï‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏Å', desc: '‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏ú‡∏•‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡πà‡∏á' },
                            { title: '‡∏ï‡∏±‡∏î‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡πÇ‡∏£‡∏Ñ‡∏à‡∏π‡πà‡πÇ‡∏à‡∏°', desc: '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏£‡πà‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏•‡∏≠‡∏∑‡πà‡∏ô' }
                        ],
                        tips: '‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ó‡∏∏‡∏Å 1-2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ù‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏π‡∏á ‡πÉ‡∏ä‡πâ‡∏õ‡∏π‡∏ô‡∏Ç‡∏≤‡∏ß‡πÇ‡∏£‡∏¢‡πÅ‡∏ú‡∏•‡∏ï‡∏±‡∏î'
                    },
                    banana_family: {
                        points: [
                            { title: '‡∏ï‡∏±‡∏î‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏´‡πâ‡∏á‡πÄ‡∏â‡∏≤', desc: '‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏û‡∏≤‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÅ‡∏°‡∏•‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π' },
                            { title: '‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏•‡∏π‡∏Å', desc: '‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏ô‡πà‡∏≠‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á 1-2 ‡∏´‡∏ô‡πà‡∏≠ ‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡∏ó‡∏¥‡πâ‡∏á' },
                            { title: '‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏î‡∏≠‡∏Å‡∏ä‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß', desc: '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡πà‡∏≤‡πÄ‡∏õ‡∏∑‡πà‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ú‡∏•' }
                        ],
                        tips: '‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏ó‡∏∏‡∏Å 2-3 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡πÉ‡∏ä‡πâ‡∏°‡∏µ‡∏î‡∏Ñ‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î‡πÇ‡∏£‡∏¢‡∏õ‡∏π‡∏ô‡∏Ç‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏µ‡πâ‡πÄ‡∏ñ‡πâ‡∏≤‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏£‡∏Ñ'
                    },
                    general: {
                        points: [
                            { title: '‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢', desc: '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏£‡∏Ñ' },
                            { title: '‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', desc: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏á‡πÅ‡∏î‡∏î' },
                            { title: '‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏î‡∏∏‡∏•', desc: '‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏ú‡∏¥‡∏î‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°' }
                        ],
                        tips: '‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏Å‡∏ï‡∏±‡∏ß ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÅ‡∏£‡∏á ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏ú‡∏•‡∏ï‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠'
                    }
                };

                return adviceMap[category] || adviceMap.general;
            } catch (error) {
                console.error('Generate cutting advice error:', error);
                return {
                    points: [
                        { title: '‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢', desc: '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏£‡∏Ñ' },
                        { title: '‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', desc: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏á‡πÅ‡∏î‡∏î' },
                        { title: '‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏î‡∏∏‡∏•', desc: '‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏ú‡∏¥‡∏î‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°' }
                    ],
                    tips: '‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏û‡∏±‡∏Å‡∏ï‡∏±‡∏ß ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏≠‡∏≤‡∏î'
                };
            }
        }

        function newScan() {
            try {
                const result = document.getElementById('result');
                const photoInput = document.getElementById('photoInput');
                const galleryInput = document.getElementById('galleryInput');
                
                if (result) {
                    result.classList.remove('show');
                }
                
                if (photoInput) {
                    photoInput.value = '';
                }
                
                if (galleryInput) {
                    galleryInput.value = '';
                }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('New scan error:', error);
                // Fallback: reload page
                window.location.reload();
            }
        }

        function showError(message) {
            try {
                const container = document.querySelector('.container');
                if (!container) return;

                // Remove existing errors
                const existingErrors = container.querySelectorAll('.error');
                existingErrors.forEach(error => error.remove());

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `‚ö†Ô∏è ${message}`;
                
                container.appendChild(errorDiv);
                
                setTimeout(() => {
                    if (errorDiv && errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 5000);
            } catch (error) {
                console.error('Show error failed:', error);
                // Fallback to alert
                alert(`‚ö†Ô∏è ${message}`);
            }
        }

        // Prevent multiple simultaneous operations
        let isProcessing = false;
        
        const originalAnalyzePhoto = analyzePhoto;
        analyzePhoto = async function(file) {
            if (isProcessing) {
                showError('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                return;
            }
            
            isProcessing = true;
            try {
                await originalAnalyzePhoto(file);
            } finally {
                isProcessing = false;
            }
        };
    </script>
</body>
</html>
